% Read temperature, pressure, and humidity data from a ThingSpeak channel over the past 24 hours 
% to calculate the average values and write to another channel. 
% The system also generates alerts based on temperature and pressure conditions.

% Channel ID to read data from
readChannelID = 1369889;
% Field IDs
TemperatureFieldID = 1;
PressureFieldID = 2;
HumidityFieldID = 3;
% Channel Read API Key
readAPIKey = 'TI15UDZ38496FELU';

% Read temperature, pressure, and humidity data for the last 24 hours from the channel.
[tempF, timeStamp] = thingSpeakRead(readChannelID, 'Fields', [TemperatureFieldID, PressureFieldID, HumidityFieldID], ...
    'numDays', 1, 'ReadKey', readAPIKey);

avgTemperature = nanmean(tempF(:,1)); % Average temperature
avgPressure = nanmean(tempF(:,2)); % Average pressure
avgHumidity = nanmean(tempF(:,3)); % Average humidity

display(avgTemperature, 'Average Temperature for the past 24 hours is');
display(avgPressure, 'Average Pressure for the past 24 hours is');
display(avgHumidity, 'Average Humidity for the past 24 hours is');

% Write average temperature and pressure to another channel
writeChannelID = 1369893;
% Write API Key
writeAPIKey = 'YMAK01DU9P9V9AOD';

thingSpeakWrite(writeChannelID, 'Fields', [1, 2, 3], 'Values', {avgTemperature, avgPressure, avgHumidity}, 'WriteKey', writeAPIKey);

% Alerts based on temperature and pressure conditions
alertApiKey = 'TAKP7C5XU9ZEVJ8GFZRXC';
alertUrl = "https://api.thingspeak.com/alerts/send";
options = weboptions("HeaderFields", ["ThingSpeak-Alerts-API-Key", alertApiKey]);
alertSubject = sprintf("Weather Notification");

if(avgTemperature > 28)
    disp('It is very hot now')
    alertBody = 'HEAT: It is very hot now';
    % Send a heat alert
    webwrite(alertUrl, "body", alertBody, "subject", alertSubject, options);
elseif(avgPressure < 970)
    disp('It is a windy day')
    alertBody = 'WIND: It is windy now';
    % Send a wind alert
    webwrite(alertUrl, "body", alertBody, "subject", alertSubject, options);
else
    disp('No update in today''s weather')
end
